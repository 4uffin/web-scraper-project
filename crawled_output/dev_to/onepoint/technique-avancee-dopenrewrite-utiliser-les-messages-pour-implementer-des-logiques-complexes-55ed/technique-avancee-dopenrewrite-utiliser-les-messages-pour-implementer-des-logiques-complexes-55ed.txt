Technique Avanc√©e d'OpenRewrite : Utiliser les messages pour impl√©menter des logiques complexes - DEV Community
Forem Feed
Follow new Subforems to improve your feed
DEV Community
Follow
A space to discuss and keep up software development and manage your software career
Gamers Forem
Follow
An inclusive community for gaming enthusiasts
Future
Follow
News and discussion of science and technology such as AI, VR, cryptocurrency, quantum computing, and more.
Music Forem
Follow
From composing and gigging to gear, hot music takes, and everything in between.
DUMB DEV Community
Follow
Memes and software development shitposting
Vibe Coding Forem
Follow
Discussing AI software development, and showing off what we're building.
Popcorn Movies and TV
Follow
Movie and TV enthusiasm, criticism and everything in-between.
Design Community
Follow
Web design, graphic design and everything in-between
Maker Forem
Follow
A community for makers, hobbyists, and professionals to discuss Arduino, Raspberry Pi, 3D printing, and much more.
Scale Forem
Follow
For engineers building software at scale. We discuss architecture, cloud-native, and SRE‚Äîthe hard-won lessons you can't just Google
Forem Core
Follow
Discussing the core forem open source software project ‚Äî features, bugs, performance, self-hosting.
Security Forem
Follow
Your central hub for all things security. From ethical hacking and CTFs to GRC and career development, for beginners and pros alike
Crypto Forem
Follow
A collaborative community for all things Crypto‚Äîfrom Bitcoin to protocol development and DeFi to NFTs and market analysis.
Open Forem
Follow
A general discussion space for the Forem community. If it doesn't have a home elsewhere, it belongs here
Dropdown menu
Dropdown menu
Skip to content
Navigation menu
Search
Powered by Algolia
Search
Log in
Create account
DEV Community
Close
Add reaction
Like
Unicorn
Exploding Head
Raised Hands
Fire
Jump to Comments
Save
Boost
More...
Moderate
Copy link
Copy link
Copied to Clipboard
Share to X
Share to LinkedIn
Share to Facebook
Share to Mastodon
Report Abuse
Kosmik
for Onepoint
Posted on Sep 11
‚Ä¢ Originally published at jtama.github.io
Technique Avanc√©e d'OpenRewrite : Utiliser les messages pour impl√©menter des logiques complexes
#java
#openrewrite
#messaging
Openrewrite (2 Part Series)
1
OpenRewrite: Refactoring as code
2
Technique Avanc√©e d'OpenRewrite : Utiliser les messages pour impl√©menter des logiques complexes
Photo par Pixabay
Je vous avais d√©j√† parl√© d‚ÄôOpenrewrite dans le premier article de cette s√©rie. Si vous ne l‚Äôavez pas lu et que vous avez besoin d‚Äôun petit rafraichissement, je vous invite √† mettre la lecture de ce post en ‚è∏Ô∏è et √† y revenir plus tard. C‚Äôest bon ? Allez go.
Tous les cas d‚Äôusage dont il a √©t√© question dans l‚Äôarticle pr√©c√©dent font intervenir une recette qui n‚Äôa besoin que des informations trouv√©es √† un et seul niveau du LST. Puisqu‚Äôune image vaut mieux qu‚Äôun long discours, et que je sens bien que je ne me suis pas tr√®s bien fait comprendre, voici un exemple cr√©dible d‚ÄôAST:
Jusqu‚Äô√† pr√©sent les exemples op√©raient des modifications sur des invocations de m√©thodes, ou par exemple un renommage de classe.
Dans le diagramme pr√©c√©dent, chaque n≈ìud correspond √† un √©l√©ment d‚ÄôAST (les choses sont √©videmments simplifi√©es ici). Comme nous l‚Äôavons d√©j√† vu, OpenRewrite utilise le pattern visiteur pour parcourir l‚Äôarbre. Plus pr√©cis√©ment les recettes impl√©mentent des visiteurs dont les interfaces correspondent au langage manipul√©.
En l‚Äôoccurence, les manipulations sont effectu√©es sur du Java, et le visiteur utilis√© sera donc un JavaIsoVisitor.
Oui, mais si mon cas d‚Äôusage n√©cessite d‚Äôidentifier une invocation de m√©thode pour agir sur la d√©claration de la m√©thode qui la contient dans une classe?
Oui, je te comprends, et cette question m‚Äôa moi aussi empecher de dormir pendant quelques jours. Seulement vois-tu, les gens derri√®res Openrewrite aussi.
Ils nous ont donc mis √† disposition un syst√®me de message tr√®s convaincant et plut√¥t s√ªr.
Cas d'usage
Imaginons que quelqu‚Äôun de mal avis√©, non, n‚Äôinsistez pas, je ne vous dirai pas qui. D‚Äôaccooooord c‚Äôest moi. Imaginons donc, disais-je, que quelqu‚Äôun de mal avis√© ait d√©velopp√© dans une librarie un moyen d‚Äôenregistrer le traitement d‚Äôune m√©thode :
import static com.github.jtama.toxic.timer.logStart;
import static com.github.jtama.toxic.timer.logEnd;
import static com.github.jtama.acme.Process.longRunningMethod;
public class ManualGearCar {
@Deprecated<4>
public void drift(String param) {
logStart();<1>
longRunningMethod(param);<2>
logEnd();<3>
}
}
Enter fullscreen mode
Exit fullscreen mode
Enregistre le d√©but d‚Äôex√©cution de la m√©thode
Ex√©cute un traitement
Enregistre la fin d‚Äôex√©cution de la m√©thode
Random annotation qui aura son int√©r√™t plus tard
Arp√®s d‚Äôintense recherche nous avons d√©couvert l‚Äôexistence de micrometer et de son annotation io.micrometer.core.annotation.Timed.
En tant que d√©veloppeur, je vais donc identifier l‚Äôinvocation de la m√©thode Timer#logStart() et si je la trouve :
La supprimer
Supprimer l‚Äôinvocation de la m√©thode Timer#logEnd() si elle existe
Ajouter l‚Äôannotation @Timed sur la d√©claration de la m√©thode drift
Et c‚Äôest exactement la logique que nous allons mettre en ≈ìuvre dans la recette.
Impl√©mentation
Dans cet exemple, nous ne regardons que l‚Äôimpl√©mentation du visiteur, pas la recette compl√®te. Mais comme d‚Äôhabitude, tout est disponible dans le d√©p√¥t github
private static class ReplaceCompareVisitor extends JavaIsoVisitor<ExecutionContext> {
private final MethodMatcher logStartInvocaMatcher = new MethodMatcher("com.github.jtama.toxic.Timer logStart()");<1>
private final MethodMatcher logEndInvocaMatcher = new MethodMatcher("com.github.jtama.toxic.Timer logEnd()");
private final AnnotationMatcher logStartMatcher = new AnnotationMatcher("@io.micrometer.core.annotation.Timed");
private final JavaTemplate annotationTemplate = JavaTemplate.builder("@Timed")
.imports("io.micrometer.core.annotation.Timed")
.javaParser(
JavaParser.fromJavaVersion()
.classpath(JavaParser.runtimeClasspath()))
.build();
public ReplaceCompareVisitor() {
maybeRemoveImport("com.github.jtama.toxic.Timer");
}
@Override
public J.MethodDeclaration visitMethodDeclaration(J.MethodDeclaration method, ExecutionContext ctx) {<3>
J.MethodDeclaration md = super.visitMethodDeclaration(method, ctx);
Cursor cursor = getCursor();
if (cursor.getMessage("appendAnnotation", false)) {
if (md.getLeadingAnnotations().stream()
.noneMatch(logStartMatcher::matches)) {
maybeAddImport("io.micrometer.core.annotation.Timed");
md = annotationTemplate.apply(cursor, method.getCoordinates().addAnnotation(Comparator.comparing(J.Annotation::getSimpleName)));
}
}
return md;
}
@Override
public J.MethodInvocation visitMethodInvocation(J.MethodInvocation method, ExecutionContext ctx) {<2>
J.MethodInvocation mi = super.visitMethodInvocation(method, ctx);
if (logStartInvocaMatcher.matches(mi) || logEndInvocaMatcher.matches(mi)) {
getCursor().putMessageOnFirstEnclosing(J.MethodDeclaration.class, "appendAnnotation", true);
return null;
}
return mi;
}
}
Enter fullscreen mode
Exit fullscreen mode
Les utilitaires
Le visiteur d‚Äôinvocation de m√©thode
Le visiteur de d√©claration de m√©thode
Les utilitaires
Dans cette section, deux outils d‚ÄôOpenRewrite sont utilis√©s. Le MethodMatcher permet d‚Äôidentifier pr√©cis√©ment les invocations de m√©thodes cibl√©es, telles que logStart() et logEnd().
L' AnnotationMatcher sert √† v√©rifier la pr√©sence de l‚Äôannotation @Timed sur une m√©thode.
Enfin, le JavaTemplate facilite l‚Äôinsertion de l‚Äôannotation dans le code source et g√®re l‚Äôimport n√©cessaire.
Ces utilitaires simplifient la manipulation de l‚ÄôAST et pr√©parent les modifications √† appliquer dans les visiteurs.
Le visiteur d'invocation de m√©thode (visitMethodInvocation)
Ce visiteur parcourt chaque appel de m√©thode dans le code source.
Lorsqu‚Äôil rencontre une invocation de logStart() ou logEnd(), il ajoute un message pour signaler qu‚Äôune annotation devra √™tre ajout√©e ult√©rieurement.
Un message n‚Äôest en r√©alit√© qu‚Äôun tuple <clef;valeur>, mais ce qui est int√©ressant ici, c‚Äôest que l‚Äôon pr√©cise le scope d‚Äôaccessibilit√© du message pour √©viter de polluer tout le contexte.
En occurrence, seul la m√©thode contenant l‚Äôinvocation en question pourra acc√©der au message(putMessageOnFirstEnclosing(J.MethodDeclaration.class...).
La valeur null renvoy√©e dans ce cas √† pour effet la suppression du n≈ìud en cours de visite, c‚Äôest-√†-dire, l‚Äôinvocation de la m√©thode.
Le visiteur de d√©claration de m√©thode(visitMethodDeclaration)
Celui-l√† est vraiment plus simple.
Si on m‚Äôa pass√© un message ET que la m√©thode n‚Äôest pas d√©j√† annot√© (si le d√©veloppeur voulait mettre ceinture et bretelle... ¬Ø\(„ÉÑ)/¬Ø ), j‚Äôajoute l‚Äôannotation @Timed.
En image
Puisqu‚Äôune image vaut mieux qu‚Äôun long discours.
Et apr√®s ?
D‚Äôautres exemples complexes suivront et n‚Äôoubliez pas que tout le code est disponible dans le d√©p√¥t Openrewrite refactoring as code.
Openrewrite (2 Part Series)
1
OpenRewrite: Refactoring as code
2
Technique Avanc√©e d'OpenRewrite : Utiliser les messages pour impl√©menter des logiques complexes
Top comments (1)
Subscribe
Personal
Trusted User
Create template
Templates let you quickly answer FAQs or store snippets for re-use.
Submit
Preview
Dismiss
Collapse
Expand
Christophe Fr√©zier
Onepoint
Christophe Fr√©zier
Onepoint
Christophe Fr√©zier
Follow
Technical Architect at @onepoint, Father of 2. Full time scheduled.
Location
Bordeaux, France
Joined
May 12, 2022
‚Ä¢
Sep 11
Dropdown menu
Copy link
Hide
Un exemple parlant et directement utilisable, je dis oui ! :)
Like comment:
Like comment:
2¬†likes
Like
Comment button
Reply
Code of Conduct
‚Ä¢
Report abuse
Are you sure you want to hide this comment? It will become hidden in your post, but will still be visible via the comment's permalink.
Hide child comments as well
Confirm
For further actions, you may consider blocking this person and/or reporting abuse
Onepoint
Follow
Beyond the Obvious
More from Onepoint
De la Programmation Orient√©e Objet vers la Programmation Orient√©e Donn√©es - Un guide pratique
#java
#dataorientedprogramming
#sealedinterfaces
#patternmatching
Supercharge Your Spring Boot App with Java 21 and Native Image
#java
#graalvm
#performance
#spring
So you wanna know where your maven dependency version comes from ?
#java
#maven
#dependencies
üíé DEV Diamond Sponsors
Thank you to our Diamond Sponsors for supporting the DEV Community
Google AI is the official AI Model and Platform Partner of DEV
Neon is the official database partner of DEV
Algolia is the official search partner of DEV
DEV Community ‚Äî A space to discuss and keep up software development and manage your software career
Home
DEV++
Podcasts
Videos
Tags
DEV Education Tracks
DEV Challenges
DEV Help
Advertise on DEV
DEV Showcase
About
Contact
Free Postgres Database
Software comparisons
Forem Shop
Code of Conduct
Privacy Policy
Terms of Use
Built on Forem ‚Äî the open source software that powers DEV and other inclusive communities.
Made with love and Ruby on Rails. DEV Community ¬© 2016 - 2025.
We're a place where coders share, stay up-to-date and grow their careers.
Log in
Create account