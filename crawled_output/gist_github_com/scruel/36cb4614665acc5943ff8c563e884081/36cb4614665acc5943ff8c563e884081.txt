ä¿®æ­£å¾®è½¯æ‹¼éŸ³è¾“å…¥æ³•æ— æ³•æ·»åŠ å¤šä¸ªæ ¼å¼åŒ–è‡ªå®šä¹‰çŸ­è¯­çš„é—®é¢˜ï¼Œé»˜è®¤æ·»åŠ  sj å’Œ rq ä¸¤ä¸ªè‡ªå®šä¹‰çŸ­è¯­ Â· GitHub
Skip to content
Search Gists
Search Gists
All gists
Back to GitHub
Sign in
Sign up
SignÂ in
SignÂ up
You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.
Dismiss alert
Instantly share code, notes, and snippets.
scruel/fix-ms-input-pinyin-phrase.py
Last active
September 24, 2025 00:21
Show Gist options
Download ZIP
Star
26
(26)
You must be signed in to star a gist
Fork
5
(5)
You must be signed in to fork a gist
Embed
Embed
Embed this gist in your website.
Share
Copy sharable link for this gist.
Clone via HTTPS
Clone using the web URL.
Learn more about clone URLs
Clone this repository at &lt;script src=&quot;https://gist.github.com/scruel/36cb4614665acc5943ff8c563e884081.js&quot;&gt;&lt;/script&gt;
Save scruel/36cb4614665acc5943ff8c563e884081 to your computer and use it in GitHub Desktop.
Code
Revisions
20
Stars
26
Forks
5
Embed
Embed
Embed this gist in your website.
Share
Copy sharable link for this gist.
Clone via HTTPS
Clone using the web URL.
Learn more about clone URLs
Clone this repository at &lt;script src=&quot;https://gist.github.com/scruel/36cb4614665acc5943ff8c563e884081.js&quot;&gt;&lt;/script&gt;
Save scruel/36cb4614665acc5943ff8c563e884081 to your computer and use it in GitHub Desktop.
Download ZIP
ä¿®æ­£å¾®è½¯æ‹¼éŸ³è¾“å…¥æ³•æ— æ³•æ·»åŠ å¤šä¸ªæ ¼å¼åŒ–è‡ªå®šä¹‰çŸ­è¯­çš„é—®é¢˜ï¼Œé»˜è®¤æ·»åŠ  sj å’Œ rq ä¸¤ä¸ªè‡ªå®šä¹‰çŸ­è¯­
Raw
fix-ms-input-pinyin-phrase.py
"""
ä¿®æ­£å¾®è½¯æ‹¼éŸ³è¾“å…¥æ³•æ— æ³•æ·»åŠ å¤šä¸ªæ ¼å¼åŒ–è‡ªå®šä¹‰çŸ­è¯­çš„é—®é¢˜
Author: Scruel Tao
"""
import os
import re
import pathlib
import traceback
from pathlib import Path
# è‡ªå®šä¹‰: ä¸‹é¢è®¾ç½®è‡ªå®šä¹‰çŸ­è¯­ï¼Œæ ¼å¼<æ‹¼éŸ³ ä½ç½® çŸ­è¯­>ï¼Œä¸€è¡Œä¸€é¡¹ï¼ŒçŸ­è¯­ä¸­å¯æ”¾å¿ƒåŒ…å«ç©ºæ ¼
# æˆ–ä¹Ÿå¯åœ¨è¯¥è„šæœ¬çš„åŒç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª phrases.txtï¼Œåœ¨å…¶ä¸­ä»¥åŒä¸€æ ¼å¼å†™å…¥è‡ªå®šä¹‰çŸ­è¯­
PHRASES_TEXT = """
rq 1 %yyyy%-%MM%-%dd%
sj 1 %yyyy%-%MM%-%dd% %HH%:%mm%:%ss%
""".strip()
LEX_FILE = os.path.join(os.getenv('APPDATA'),
r'Microsoft\InputMethod\Chs\ChsPinyinEUDPv1.lex')
HEADER_LEN = 16 + 4
PHRASE_64PCNT_POS = HEADER_LEN
TOTAL_BYTES_POS = HEADER_LEN + 4
PHRASE_CNT_POS = HEADER_LEN + 8
PADDED_ENCODING = 'utf-16le'
HEADER_BYTES = bytes('mschxudp', encoding='ascii')
HEADER_BYTES = HEADER_BYTES + bytes('\x02\x60\x01\x00', PADDED_ENCODING)
PHRASE_SEPARATOR_BYTES = b'\x00\x00'
PHRASE_SEPARATOR_SIZE = len(PHRASE_SEPARATOR_BYTES)
PHRASE_LEN_FIRST_POS = PHRASE_CNT_POS + 40
phrase_fixed_last_bytes = b'\xA5\x2C'
def read_bytes(position, length=1):
with open(LEX_FILE, 'rb+') as file:
file.seek(position)
return file.read(length)
def replace_bytes(position, value):
with open(LEX_FILE, 'rb+') as file:
file.seek(position)
data = file.read()
file.seek(position)
file.write(value + data[len(value):])
def bytes2int(data):
return int.from_bytes(data, byteorder='little')
def int2bytes(data, length=1):
return int.to_bytes(data, length=length, byteorder='little')
def padded_bytes(s):
def padded_byte(c):
b = bytes(c, PADDED_ENCODING)
return b + b'\x00' if len(b) == 1 else b
return b''.join([padded_byte(c) for c in s])
def get_phrase_header(header_pinyin_len, index):
return (b'\x10\x00\x10\x00' + int2bytes(header_pinyin_len, 2)
+ int2bytes(index) + b'\x06\x00\x00\x00\x00' + b'\x00\x00'
+ phrase_fixed_last_bytes)
def main():
global phrase_fixed_last_bytes
current_dir = os.path.dirname(os.path.realpath(__file__))
phrases_file = Path(current_dir) / 'phrases.txt'
phrases_text = PHRASES_TEXT
if phrases_file.exists():
try:
phrases_file_text = phrases_file.read_text('utf-8')
except:
phrases_file_text = phrases_file.read_text('gbk')
phrases_text += '\n' + phrases_file_text.replace('\r\n', '\n')
phrase_items = list(set([x.strip() for x in phrases_text.split('\n') if x]))
print(f"==================\n"
f"Author: Scruel Tao\n"
f"==================\n\n"
f"æ­£åœ¨ä¿®æ­£å·¨ç¡¬æ‹¼éŸ³å¹¶æ·»åŠ \n"
f"é¢„ç½®çš„æ—¥æœŸæ ¼å¼åŒ–çŸ­è¯­â€¦â€¦\n"
f"\n"
f"çŸ­è¯­æ•°é‡ï¼š{len(phrase_items)}\n"
)
last_phrase_pos = 0
phrase_list = []
# (is_new, pinyin, header, phrase))
if not os.path.exists(LEX_FILE):
with open(LEX_FILE, 'wb') as f:
# Initing lex file
f.write(HEADER_BYTES)
f.write((b'\x40' + b'\x00' * 3) * 3)
f.write(b'\x00' * 4)
f.write(b'\x38\xd2\xa3\x65')
f.write(b'\x00' * 32)
else:
phrase_cnt = bytes2int(read_bytes(PHRASE_CNT_POS, 4))
phrase_block_first_pos = PHRASE_LEN_FIRST_POS + 4 * (phrase_cnt - 1)
# Read existing phrases
for i in range(phrase_cnt):
if i == phrase_cnt - 1:
phrase_block_pos = phrase_block_len = -1
else:
phrase_block_pos = bytes2int(
read_bytes(PHRASE_LEN_FIRST_POS + i * 4, 4))
phrase_block_len = phrase_block_pos - last_phrase_pos
phrase_block_bytes = read_bytes(
phrase_block_first_pos + last_phrase_pos, phrase_block_len)
last_phrase_pos = phrase_block_pos
pinyin_bytes, phrase_bytes = re.match(
(b'(.+)' + PHRASE_SEPARATOR_BYTES) * 2, phrase_block_bytes[16:]).groups()
phrase_fixed_last_bytes = phrase_block_bytes[14:16]
# Prevent deleted phrases
if phrase_block_bytes[9:10] == b'\x00':
phrase_list.append((0, pinyin_bytes,
phrase_block_bytes[:16], phrase_bytes))
# Fix custom phrases
for item in phrase_items:
if not item:
continue
pinyin, index, phrase = item.split(maxsplit=2)
pinyin_bytes = padded_bytes(pinyin)
phrase_bytes = padded_bytes(phrase)
phrase_list = [x for x in phrase_list if x[0] or not x[1] == pinyin_bytes]
header = get_phrase_header(
16 + len(pinyin_bytes) + PHRASE_SEPARATOR_SIZE, int(index))
phrase_list.append((1, pinyin_bytes, header, phrase_bytes))
# Necessary fix, otherwise the order of phrases will be messed up.
phrase_list.sort(key=lambda x: x[1])
# Write phrases
tolast_phrase_pos = 0
total_size = PHRASE_LEN_FIRST_POS
with open(LEX_FILE, 'rb+') as file:
file.seek(PHRASE_LEN_FIRST_POS)
file.truncate()
for _, *items in phrase_list[:-1]:
phrase_len = sum(map(len, items)) + PHRASE_SEPARATOR_SIZE * 2
tolast_phrase_pos += phrase_len
file.write(int2bytes(tolast_phrase_pos, length=4))
total_size += PHRASE_SEPARATOR_SIZE * 2
for _, pinyin_bytes, header, phrase_bytes in phrase_list:
file.write(header)
data_bytes = PHRASE_SEPARATOR_BYTES.join(
[pinyin_bytes, phrase_bytes, b''])
file.write(data_bytes)
total_size += len(header) + len(data_bytes)
# Fix file header
replace_bytes(PHRASE_64PCNT_POS, int2bytes(
64 + len(phrase_list) * 4, length=4))
replace_bytes(PHRASE_CNT_POS, int2bytes(len(phrase_list), length=4))
replace_bytes(TOTAL_BYTES_POS, int2bytes(total_size, length=4))
if __name__ == "__main__":
try:
main()
print('Done')
except:
traceback.print_exc()
os.system('pause')
Copy link
latv666
commented
Oct 7, 2023
ä½ å¥½,éå¸¸æ„Ÿè°¢ä½ åœ¨å›½åº†æœŸé—´å†™äº†è¿™ä¸ªè„šæœ¬
æˆ‘åœ¨è¿è¡Œæ—¶æŠ¥é”™,å¦‚å›¾,ç¯å¢ƒæ˜¯ VMware 16 + win10 x64 + python 3.12
ç›®å‰æ˜¯å¯ä»¥è‡ªå®šä¹‰é¦–ä¸ªå€™é€‰å­—,å¯ä¸å¯ä»¥å®šä¹‰ä¸ºé¦–ä¸ªä»¥å¤–çš„å€™é€‰å­—? æ¯”å¦‚æˆ‘è‡ªå®šä¹‰ rq,é¦–å€™é€‰å­—æ˜¯ 2023å¹´10æœˆ07æ—¥,æ¬¡å€™é€‰å­—æ˜¯ 2023å¹´10æœˆ07æ—¥_125521
å¦å¤–è¿™ä¸ªè„šæœ¬ä¼¼ä¹å¯¹ä¸­æ–‡æ”¯æŒçš„ä¸æ˜¯å¾ˆå¥½,æ¯”å¦‚æˆ‘è‡ªå®šä¹‰çš„æ˜¯ %yyyy%å¹´%MM%æœˆ%dd%æ—¥,å¥½åƒä¹Ÿä¼šæŠ¥é”™
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
Author
scruel
commented
Oct 7, 2023
@latv666 çœ‹äº†ä¸‹ä¹‹å‰ä¸Šä¼ çš„æ˜¯å†™äº†ä¸€åŠçš„ä»£ç ï¼Œç°åœ¨æ²¡é—®é¢˜äº†ã€‚
åŒæ—¶é¡ºä¾¿ç®€åŒ–äº†ä¸€ä¸‹ä»£ç ï¼Œå¢åŠ äº†ä½ è¦çš„è‡ªå®šä¹‰å€™é€‰è¯ä½ç½®å’Œå¯¹ä¸­æ–‡çš„æ”¯æŒã€‚
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
latv666
commented
Oct 7, 2023
@latv666 çœ‹äº†ä¸‹ä¹‹å‰ä¸Šä¼ çš„æ˜¯å†™äº†ä¸€åŠçš„ä»£ç ï¼Œç°åœ¨æ²¡é—®é¢˜äº†ã€‚ åŒæ—¶é¡ºä¾¿ç®€åŒ–äº†ä¸€ä¸‹ä»£ç ï¼Œå¢åŠ äº†ä½ è¦çš„è‡ªå®šä¹‰å€™é€‰è¯ä½ç½®å’Œå¯¹ä¸­æ–‡çš„æ”¯æŒã€‚
éå¸¸æ„Ÿè°¢,æµ‹è¯•æˆåŠŸ
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
SuperMonkeyC1
commented
Oct 11, 2023
éå¸¸æ„Ÿè°¢ï¼Œé—®é¢˜å·²ç»è§£å†³äº†~
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
JiangSNZero
commented
Feb 28, 2024
éå¸¸æ„Ÿè°¢!æ‚¨ç¼–å†™çš„è„šæœ¬æˆåŠŸçš„å¸®åŠ©äº†æˆ‘ğŸ‘
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
Roadelse
commented
Mar 19, 2024
éå¸¸æ„Ÿè°¢, è®©æˆ‘ä¸ç”¨å†å»ä¸‹è½½qqè¾“å…¥æ³•äº†...
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
snsnsjsn
commented
Apr 10, 2024
æ•ˆæœéå¸¸å¥½ï¼Œè§£å†³äº†æ‰‹åŠ¨è®¾ç½®ä¸¤ä¸ªå˜é‡ï¼Œå°±æ— æ³•ä½¿ç”¨
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
luoshuaidev
commented
May 11, 2024
Traceback (most recent call last):
File "PyCharm2023.3\light-edit\fix-ms-input-pinyin-phrase.py", line 168, in <module>
main()
File "PyCharm2023.3\light-edit\fix-ms-input-pinyin-phrase.py", line 118, in main
pinyin_bytes, phrase_bytes = re.match(
AttributeError: 'NoneType' object has no attribute 'groups'
4æœˆ2æ—¥ä½¿æ˜¯æ­£å¸¸çš„, è¿™æ¬¡ä½¿ç”¨å°±æŠ¥é”™äº†.
æˆ‘å°è¯•äº†æœ€æ–°ç‰ˆä¹Ÿæ˜¯è¿™é‡ŒæŠ¥é”™, æˆ‘ä¹Ÿå°è¯•äº†å…ˆæ¸…ç©ºè‡ªå®šä¹‰çŸ­è¯­, ç›´æ¥ä½¿ç”¨, è¿˜æ˜¯åŒæ ·çš„é—®é¢˜.
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
Author
scruel
commented
May 16, 2024
@luoshuaidev æˆ‘è¿™é‡Œä»æ­£å¸¸ï¼Œå¦å¤–æœ€è¿‘æ¯”è¾ƒå¿™ï¼Œå¯èƒ½æ²¡æ—¶é—´è§£å†³ç›¸å…³é—®é¢˜ï¼Œå»ºè®®è‡ªè¡Œè°ƒè¯•ä¸€ä¸‹ã€‚
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
danangua
commented
Oct 15, 2024
éå¸¸æ„Ÿè°¢ï¼Œè§£å†³äº†ä¸€ä¸ªå¤§å›°æ‰°ã€‚
è¢«å¼ºè¿«ç”¨å¾®è½¯æ‹¼éŸ³ï¼Œä¸å¾—ä¸è‡ªå·±è§£å†³é—®é¢˜ã€‚ä¸‹ä¸€ä¸ªæ˜¯è‡ªå®šä¹‰æ ‡ç‚¹ç¬¦å·çš„ï¼Œå¸Œæœ›ä¹Ÿèƒ½æ‰¾åˆ°æ›´å¥½çš„æ–¹æ¡ˆã€‚ä¾‹å¦‚æˆ‘å¸Œæœ›ä¸­æ–‡æ¨¡å¼ä¸‹/ å’Œ _ æ˜¯è‹±æ–‡æ ‡ç‚¹ï¼Œè€Œä¸æ˜¯é¡¿å·å’Œç ´æŠ˜å·
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
Author
scruel
commented
Oct 25, 2024
â€¢
edited
Loading
Uh oh!
There was an error while loading. Please reload this page.
è¢«å¼ºè¿«ç”¨å¾®è½¯æ‹¼éŸ³ï¼Œä¸å¾—ä¸è‡ªå·±è§£å†³é—®é¢˜ã€‚ä¸‹ä¸€ä¸ªæ˜¯è‡ªå®šä¹‰æ ‡ç‚¹ç¬¦å·çš„ï¼Œå¸Œæœ›ä¹Ÿèƒ½æ‰¾åˆ°æ›´å¥½çš„æ–¹æ¡ˆã€‚ä¾‹å¦‚æˆ‘å¸Œæœ›ä¸­æ–‡æ¨¡å¼ä¸‹/ å’Œ _ æ˜¯è‹±æ–‡æ ‡ç‚¹ï¼Œè€Œä¸æ˜¯é¡¿å·å’Œç ´æŠ˜å·
æœ¬èº«æ”¯æŒçš„ï¼ŒæŒ‰ Ctrl + . åˆ‡æ¢
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
danangua
commented
Oct 25, 2024
åˆ‡æ¢è´¹æ‰‹å•Šï¼Œè¿˜èƒ½ç›´æ¥å¿«æ·é”®åˆ‡æ¢åˆ«çš„è¾“å…¥æ³•å‘¢ï¼Œå…¶ä»–å›½äº§è¾“å…¥æ³•èƒ½è‡ªå®šä¹‰æ ‡ç‚¹æ ¹æœ¬æ²¡æœ‰è¿™ç§é—®é¢˜ã€‚
ç›®å‰åªæ˜¯ç”¨å›äº†å¾®è½¯æ‹¼éŸ³æ—§ç‰ˆï¼Œè‡³å°‘/=/ï¼Œä¸å†æ˜¯è®¨åŒçš„ã€äº†ã€‚ä¸‹åˆ’çº¿æš‚æ—¶æ— è§£ã€‚
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Copy link
Mjhjh
commented
Apr 21, 2025
å¾ˆæœ‰ç”¨çš„è„šæœ¬ï¼Œéå¸¸æ„Ÿè°¢åˆ†äº«
Sorry, something went wrong.
Uh oh!
There was an error while loading. Please reload this page.
Sign up for free
to join this conversation on GitHub.
Already have an account?
Sign in to comment
Footer
Â© 2025 GitHub,Â Inc.
Footer navigation
Terms
Privacy
Security
Status
Community
Docs
Contact
Manage cookies
Do not share my personal information
You canâ€™t perform that action at this time.